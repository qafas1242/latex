<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI LaTeX Editor</title>
    
    <!-- Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\\\]']],
                processEscapes: true,
                packages: {
                    '[+]': [
                        'ams',
                        'amsmath',
                        'mathtools',
                        'physics',
                        'mhchem',
                        'color'
                    ]
                }
            },
            svg: {
                fontCache: 'global'
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    window.mathJaxReady = true;
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* Base Styles */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #F5F5F7;
            color: #1D1D1F;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #D1D1D6;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #8E8E93;
        }

        /* Utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04);
        }
        
        .subtle-shadow-out {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
        }
        .subtle-shadow-in {
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        /* Preset Item Styles */
        .preset-item {
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
            background-color: white;
            border: 1px solid #E5E7EB;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-bottom: 24px;
            backface-visibility: hidden; /* For smoother transform */
        }
        .preset-item:hover {
            transform: translateY(-2px);
            border-color: #d1d5db;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }
        .preset-item:active {
            transform: scale(0.98);
        }
        
        .preset-preview-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 8px;
        }

        .preset-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 24px;
            background-color: #F9FAFB;
            color: #6B7280;
            font-size: 11px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 8px;
            border-top: 1px solid #E5E7EB;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Category Button */
        .category-btn {
            transition: all 0.2s ease;
            background-color: transparent;
            border-radius: 0.75rem;
            position: relative;
            overflow: hidden;
        }
        .category-btn.active {
            background-color: #ffffff;
            color: #111827;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        .category-btn:not(.active):hover {
            background-color: rgba(255,255,255,0.5);
        }
        
        /* MathJax Tweaks */
        mjx-container {
            font-size: 110% !important;
            outline: none;
        }
        
        /* Improved Animations */
        .content-transition-wrapper {
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            opacity: 1;
            transform: translateY(0);
        }
        
        .content-hidden {
            opacity: 0;
            transform: translateY(5px);
            pointer-events: none; /* Prevent clicks during transition */
        }

        @keyframes pulse-subtle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-subtle {
            animation: pulse-subtle 2s ease-in-out infinite;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-[#F5F5F7]">

    <!-- Header -->
    <header class="h-16 bg-white/80 backdrop-blur-xl border-b border-gray-200 flex items-center justify-between px-6 shrink-0 z-40 subtle-shadow-out">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-black rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg shadow-black/20">
                <i data-lucide="sigma" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-tight text-gray-900 leading-none">LaTeX Studio</h1>
                <span class="text-[10px] font-medium text-gray-400 uppercase tracking-widest">AI Enhanced</span>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <!-- Export Dropdown -->
            <div class="relative inline-block text-left">
                <button id="exportButton" class="text-sm font-medium text-gray-600 hover:text-gray-900 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-1.5">
                    <i data-lucide="download" class="w-4 h-4"></i> 내보내기
                </button>
                <div id="exportDropdown" class="absolute right-0 mt-2 w-56 rounded-xl shadow-2xl bg-white ring-1 ring-black ring-opacity-5 z-50 hidden border border-gray-100 transition-all duration-200 origin-top-right scale-95 opacity-0" style="display: none;">
                    <div class="py-1">
                        <div class="flex items-center justify-between px-4 py-2 text-sm text-gray-700 border-b border-gray-50">
                            <span class="font-medium">수식 색상</span>
                            <input type="color" id="exportColorPicker" value="#1D1D1F" class="cursor-pointer w-6 h-6 rounded-full border-0 p-0">
                        </div>
                        <a href="#" onclick="exportFormula('svg'); return false;" class="flex items-center gap-2 px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                            <i data-lucide="file-text" class="w-4 h-4 text-gray-400"></i> SVG로 저장
                        </a>
                        <a href="#" onclick="exportFormula('png'); return false;" class="flex items-center gap-2 px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                            <i data-lucide="image" class="w-4 h-4 text-gray-400"></i> PNG로 저장
                        </a>
                    </div>
                </div>
            </div>
            
             <button onclick="copyToClipboard()" class="text-sm font-medium text-blue-600 hover:text-blue-700 hover:bg-blue-50 px-3 py-2 rounded-lg transition-colors flex items-center gap-1.5">
                <i data-lucide="copy" class="w-4 h-4"></i> 복사
            </button>
            <button onclick="clearEditor()" class="text-sm font-medium text-red-500 hover:text-red-600 hover:bg-red-50 px-3 py-2 rounded-lg transition-colors flex items-center gap-1.5">
                <i data-lucide="trash-2" class="w-4 h-4"></i> 초기화
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden p-4 gap-4">
        
        <!-- Left Sidebar: Categories -->
        <aside class="w-64 bg-gray-50/80 backdrop-blur rounded-2xl border border-gray-200/60 flex flex-col shrink-0 overflow-hidden subtle-shadow-out">
            <div class="p-4 border-b border-gray-200/50">
                <span class="text-[11px] font-bold text-gray-400 uppercase tracking-widest">Library</span>
            </div>
            <!-- Categories List -->
            <div class="flex-1 overflow-y-auto p-3 space-y-1" id="categoryList">
                <!-- Categories injected via JS -->
            </div>
        </aside>

        <!-- Middle: Presets / Search / AI Interface -->
        <section class="w-80 bg-white rounded-2xl border border-gray-200 flex flex-col shrink-0 relative overflow-hidden subtle-shadow-out">
            
            <!-- Dynamic Header -->
            <div id="presetHeader" class="p-3 border-b border-gray-100 bg-white/90 backdrop-blur z-10 sticky top-0">
                <!-- Content injected via JS -->
            </div>

            <!-- Content Area (Grid or AI Form) -->
            <div id="presetsGridContainer" class="flex-1 overflow-y-auto p-3 relative">
                <!-- Wrapper for animation -->
                <div id="presetsGrid" class="content-transition-wrapper min-h-full">
                    <!-- Content injected via JS -->
                </div>
            </div>
        </section>

        <!-- Right: Editor & Preview -->
        <section class="flex-1 flex flex-col min-w-0 bg-white rounded-2xl border border-gray-200 overflow-hidden subtle-shadow-out shadow-xl">
            
            <!-- Editor Area -->
            <div class="h-2/5 flex flex-col border-b border-gray-200 relative group bg-gray-50/30">
                <div class="absolute top-0 left-0 right-0 px-4 py-2 bg-gray-50/80 border-b border-gray-100 flex justify-between items-center z-10 backdrop-blur-sm">
                    <span class="text-xs font-semibold text-gray-500 flex items-center gap-1.5 uppercase tracking-wide">
                        <i data-lucide="code-2" class="w-3.5 h-3.5"></i> LaTeX Source
                    </span>
                </div>
                <textarea id="latexInput" spellcheck="false"
                    class="flex-1 w-full p-6 pt-12 resize-none outline-none font-mono text-gray-800 text-lg leading-relaxed selection:bg-indigo-100 bg-transparent"
                    placeholder="\documentclass{article} ... 여기에 수식을 입력하세요."></textarea>
            </div>

            <!-- Preview Area -->
            <div class="h-3/5 flex flex-col bg-white relative">
                <div class="absolute top-0 left-0 right-0 px-4 py-2 bg-white border-b border-gray-100 flex justify-between items-center z-10">
                    <span class="text-xs font-semibold text-gray-500 flex items-center gap-1.5 uppercase tracking-wide">
                        <i data-lucide="eye" class="w-3.5 h-3.5"></i> Live Preview
                    </span>
                </div>
                <div class="flex-1 p-8 pt-12 overflow-y-auto flex items-center justify-center bg-white" id="previewContainer">
                    <div id="previewOutput" class="w-full max-w-4xl text-center text-3xl text-gray-800 transition-all duration-200">
                        $$\text{수식을 입력하세요}$$
                    </div>
                </div>
            </div>

        </section>

    </main>

    <script>
        // --- Data Configuration ---
        const latexData = [
            {
                id: "search",
                name: "검색",
                color: "bg-gray-500",
                icon: "search",
                isSearch: true,
                items: []
            },
            // [NEW] AI Generator Category
            {
                id: "ai-generate",
                name: "AI로 생성",
                color: "bg-gradient-to-br from-indigo-500 to-purple-600",
                icon: "sparkles",
                isAi: true,
                items: []
            },
            {
                id: "greek",
                name: "그리스 문자",
                color: "bg-red-500",
                icon: "languages",
                items: [
                    { latex: "\\alpha", name: "알파", keywords: "alpha a" },
                    { latex: "\\beta", name: "베타", keywords: "beta b" },
                    { latex: "\\gamma", name: "감마", keywords: "gamma g" },
                    { latex: "\\Gamma", name: "감마(대)", keywords: "Gamma G" },
                    { latex: "\\delta", name: "델타", keywords: "delta d" },
                    { latex: "\\Delta", name: "델타(대)", keywords: "Delta D" },
                    { latex: "\\epsilon", name: "입실론", keywords: "epsilon e" },
                    { latex: "\\varepsilon", name: "입실론(변형)", keywords: "varepsilon" },
                    { latex: "\\zeta", name: "제타", keywords: "zeta z" },
                    { latex: "\\eta", name: "에타", keywords: "eta h" },
                    { latex: "\\theta", name: "세타", keywords: "theta" },
                    { latex: "\\Theta", name: "세타(대)", keywords: "Theta" },
                    { latex: "\\lambda", name: "람다", keywords: "lambda l" },
                    { latex: "\\Lambda", name: "람다(대)", keywords: "Lambda L" },
                    { latex: "\\mu", name: "뮤", keywords: "mu m" },
                    { latex: "\\xi", name: "크사이", keywords: "xi x" },
                    { latex: "\\pi", name: "파이", keywords: "pi p" },
                    { latex: "\\Pi", name: "파이(대)", keywords: "Pi P" },
                    { latex: "\\rho", name: "로", keywords: "rho r" },
                    { latex: "\\sigma", name: "시그마", keywords: "sigma s" },
                    { latex: "\\Sigma", name: "시그마(대)", keywords: "Sigma S 합" },
                    { latex: "\\tau", name: "타우", keywords: "tau t" },
                    { latex: "\\phi", name: "파이(phi)", keywords: "phi f" },
                    { latex: "\\Phi", name: "파이(대)", keywords: "Phi F" },
                    { latex: "\\psi", name: "프사이", keywords: "psi" },
                    { latex: "\\omega", name: "오메가", keywords: "omega w" },
                    { latex: "\\Omega", name: "오메가(대)", keywords: "Omega W" }
                ]
            },
            {
                id: "operators",
                name: "연산자",
                color: "bg-orange-500",
                icon: "plus", 
                items: [
                    { latex: "\\times", name: "곱하기", keywords: "times multiply" },
                    { latex: "\\div", name: "나누기", keywords: "div divide" },
                    { latex: "\\cdot", name: "내적(점)", keywords: "cdot dot" },
                    { latex: "\\pm", name: "플러스마이너스", keywords: "pm plus minus" },
                    { latex: "\\mp", name: "마이너스플러스", keywords: "mp minus plus" },
                    { latex: "\\cap", name: "교집합", keywords: "cap intersection" },
                    { latex: "\\cup", name: "합집합", keywords: "cup union" },
                    { latex: "\\wedge", name: "논리곱(And)", keywords: "wedge and" },
                    { latex: "\\vee", name: "논리합(Or)", keywords: "vee or" },
                    { latex: "\\oplus", name: "직합", keywords: "oplus" },
                    { latex: "\\otimes", name: "텐서곱", keywords: "otimes tensor" }
                ]
            },
            {
                id: "relations",
                name: "관계 기호",
                color: "bg-amber-500",
                icon: "scale",
                items: [
                    { latex: "=", name: "같음", keywords: "equal" },
                    { latex: "\\neq", name: "같지 않음", keywords: "neq not equal" },
                    { latex: "\\leq", name: "작거나 같음", keywords: "leq" },
                    { latex: "\\geq", name: "크거나 같음", keywords: "geq" },
                    { latex: "\\equiv", name: "합동", keywords: "equiv" },
                    { latex: "\\approx", name: "근사", keywords: "approx" },
                    { latex: "\\in", name: "원소", keywords: "in element" },
                    { latex: "\\subset", name: "부분집합", keywords: "subset" },
                    { latex: "\\perp", name: "수직", keywords: "perp" },
                    { latex: "\\parallel", name: "평행", keywords: "parallel" },
                    { latex: "\\propto", name: "비례", keywords: "propto" }
                ]
            },
            {
                id: "arrows",
                name: "화살표",
                color: "bg-lime-500",
                icon: "move-right",
                items: [
                    { latex: "\\rightarrow", name: "오른쪽", keywords: "rightarrow right to" },
                    { latex: "\\leftarrow", name: "왼쪽", keywords: "leftarrow left" },
                    { latex: "\\leftrightarrow", name: "양쪽", keywords: "leftrightarrow" },
                    { latex: "\\Rightarrow", name: "함의", keywords: "Rightarrow implies" },
                    { latex: "\\iff", name: "필요충분", keywords: "iff" },
                    { latex: "\\uparrow", name: "위", keywords: "uparrow" },
                    { latex: "\\downarrow", name: "아래", keywords: "downarrow" }
                ]
            },
            {
                id: "logic",
                name: "논리 및 집합",
                color: "bg-emerald-500",
                icon: "network",
                items: [
                    { latex: "\\forall", name: "모든", keywords: "forall" },
                    { latex: "\\exists", name: "존재", keywords: "exists" },
                    { latex: "\\neg", name: "부정", keywords: "neg not" },
                    { latex: "\\emptyset", name: "공집합", keywords: "emptyset" },
                    { latex: "\\infty", name: "무한대", keywords: "infty infinity" },
                    { latex: "\\therefore", name: "그러므로", keywords: "therefore" },
                    { latex: "\\because", name: "왜냐하면", keywords: "because" }
                ]
            },
            {
                id: "delimiters",
                name: "괄호 및 구분자",
                color: "bg-teal-500",
                icon: "brackets",
                items: [
                    { latex: "\\left( \\right)", name: "소괄호", keywords: "parentheses" },
                    { latex: "\\left[ \\right]", name: "대괄호", keywords: "brackets" },
                    { latex: "\\left\\{ \\right\\}", name: "중괄호", keywords: "braces" },
                    { latex: "\\langle \\rangle", name: "홑화살괄호", keywords: "langle rangle" },
                    { latex: "| |", name: "절댓값", keywords: "abs" }
                ]
            },
            {
                id: "bigops",
                name: "대형 연산자",
                color: "bg-cyan-500",
                icon: "sigma",
                items: [
                    { latex: "\\sum", name: "합(Sum)", keywords: "sum sigma" },
                    { latex: "\\prod", name: "곱(Prod)", keywords: "prod product" },
                    { latex: "\\int", name: "적분", keywords: "int integral" },
                    { latex: "\\oint", name: "선적분", keywords: "oint contour" },
                    { latex: "\\bigcap", name: "교집합(대)", keywords: "bigcap" },
                    { latex: "\\bigcup", name: "합집합(대)", keywords: "bigcup" }
                ]
            },
            {
                id: "functions",
                name: "표준 함수",
                color: "bg-indigo-500",
                icon: "function-square",
                items: [
                    { latex: "\\sin", name: "sin", keywords: "sine" },
                    { latex: "\\cos", name: "cos", keywords: "cosine" },
                    { latex: "\\tan", name: "tan", keywords: "tangent" },
                    { latex: "\\log", name: "log", keywords: "logarithm" },
                    { latex: "\\ln", name: "ln", keywords: "natural logarithm" },
                    { latex: "\\lim", name: "limit", keywords: "lim limit" }
                ]
            },
            {
                id: "layout",
                name: "구조 및 공백",
                color: "bg-violet-500",
                icon: "layout",
                items: [
                    { latex: "\\frac{a}{b}", name: "분수", keywords: "frac fraction" },
                    { latex: "\\sqrt{x}", name: "제곱근", keywords: "sqrt root" },
                    { latex: "\\binom{n}{k}", name: "이항계수", keywords: "binom" },
                    { latex: "\\quad", name: "공백", keywords: "quad space" },
                    { latex: "\\\\", name: "줄바꿈", keywords: "newline" }
                ]
            },
            {
                id: "matrices",
                name: "행렬 및 환경",
                color: "bg-purple-500",
                icon: "grid",
                items: [
                    { latex: "\\begin{matrix} a & b \\\\ c & d \\end{matrix}", name: "행렬(기본)", keywords: "matrix" },
                    { latex: "\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}", name: "행렬(소괄호)", keywords: "pmatrix" },
                    { latex: "\\begin{bmatrix} a & b \\\\ c & d \\end{bmatrix}", name: "행렬(대괄호)", keywords: "bmatrix" },
                    { latex: "\\begin{cases} a & x>0 \\\\ b & x<0 \\end{cases}", name: "경우의 수", keywords: "cases" }
                ]
            },
            {
                id: "misc",
                name: "기타 기호",
                color: "bg-pink-500",
                icon: "asterisk",
                items: [
                    { latex: "\\nabla", name: "나블라", keywords: "nabla" },
                    { latex: "\\partial", name: "편미분", keywords: "partial" },
                    { latex: "\\ell", name: "l (필기체)", keywords: "ell" },
                    { latex: "\\angle", name: "각도", keywords: "angle" },
                    { latex: "\\triangle", name: "삼각형", keywords: "triangle" }
                ]
            }
        ];

        const allItems = latexData.flatMap(cat => cat.items || []);

        // --- State ---
        let currentCategory = latexData[0];
        
        // --- Elements ---
        const categoryList = document.getElementById('categoryList');
        const presetHeader = document.getElementById('presetHeader');
        const presetsGrid = document.getElementById('presetsGrid');
        const latexInput = document.getElementById('latexInput');
        const previewOutput = document.getElementById('previewOutput');
        const exportButton = document.getElementById('exportButton');
        const exportDropdown = document.getElementById('exportDropdown');
        const exportColorPicker = document.getElementById('exportColorPicker');

        // --- Initialization ---
        function init() {
            renderCategories();
            selectCategory(latexData[0]); 
            lucide.createIcons();
            updatePreview();

            // Export Dropdown Logic with Animation
            exportButton.addEventListener('click', (e) => {
                e.stopPropagation();
                if (exportDropdown.style.display === 'none') {
                    exportDropdown.style.display = 'block';
                    // Trigger reflow
                    exportDropdown.offsetHeight;
                    exportDropdown.classList.remove('opacity-0', 'scale-95');
                    exportDropdown.classList.add('opacity-100', 'scale-100');
                } else {
                    closeExportDropdown();
                }
            });
            document.addEventListener('click', closeExportDropdown);
            exportDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }

        function closeExportDropdown() {
            exportDropdown.classList.remove('opacity-100', 'scale-100');
            exportDropdown.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                if (exportDropdown.classList.contains('opacity-0')) {
                    exportDropdown.style.display = 'none';
                }
            }, 200);
        }

        // --- Rendering Categories ---
        function renderCategories() {
            categoryList.innerHTML = '';
            
            latexData.forEach(cat => {
                const btn = document.createElement('button');
                const isActive = currentCategory.id === cat.id;
                
                let iconBg = cat.color;
                
                btn.className = `category-btn w-full text-left px-3 py-2.5 rounded-xl flex items-center gap-3 mb-1.5 border border-transparent ${isActive ? 'active' : 'text-gray-500 hover:text-gray-900'}`;
                
                const iconContainer = document.createElement('div');
                iconContainer.className = `w-7 h-7 rounded-lg flex items-center justify-center text-white shadow-sm shrink-0 ${iconBg} ${isActive ? 'ring-2 ring-offset-2 ring-gray-200' : ''}`;
                iconContainer.innerHTML = `<i data-lucide="${cat.icon}" class="w-3.5 h-3.5"></i>`;

                const textSpan = document.createElement('span');
                textSpan.className = "text-sm font-medium tracking-tight";
                textSpan.textContent = cat.name;
                
                // Add "NEW" badge for AI
                if(cat.id === 'ai-generate') {
                    const badge = document.createElement('span');
                    badge.className = "ml-auto text-[9px] font-bold bg-indigo-100 text-indigo-600 px-1.5 py-0.5 rounded shadow-sm";
                    badge.textContent = "AI";
                    btn.appendChild(iconContainer);
                    btn.appendChild(textSpan);
                    btn.appendChild(badge);
                } else {
                    btn.appendChild(iconContainer);
                    btn.appendChild(textSpan);
                }

                btn.onclick = () => selectCategory(cat);
                categoryList.appendChild(btn);
            });
            lucide.createIcons();
        }

        function selectCategory(cat) {
            // Avoid re-rendering if clicking same category (optional, but good for performance)
            if (currentCategory.id === cat.id) return;

            // 1. Fade Out
            presetsGrid.classList.add('content-hidden');

            // 2. Wait for fade out, then render new content
            setTimeout(() => {
                currentCategory = cat;
                renderCategories(); // Update sidebar active state
                renderHeader();
                
                // Reset grid layout classes
                presetsGrid.className = 'content-transition-wrapper min-h-full flex-1 overflow-y-auto p-3 flex flex-wrap gap-3 content-start pb-10 content-hidden'; // Start hidden

                if (cat.id === 'search') {
                    renderSearchUI();
                } else if (cat.id === 'ai-generate') {
                    renderAiInterface();
                } else {
                    renderPresets(cat.items);
                }
                
                // 3. Fade In (small delay to ensure DOM update)
                requestAnimationFrame(() => {
                    presetsGrid.classList.remove('content-hidden');
                });
                
            }, 200); // Matches CSS transition time
        }

        function renderHeader() {
            presetHeader.innerHTML = '';

            if (currentCategory.id === 'search') {
                const searchContainer = document.createElement('div');
                searchContainer.className = "relative animate-fade-in";
                
                const icon = document.createElement('i');
                icon.setAttribute('data-lucide', 'search');
                icon.className = "absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4";
                
                const input = document.createElement('input');
                input.type = "text";
                input.id = "categorySearchInput";
                input.placeholder = "명령어, 키워드 검색...";
                input.className = "w-full pl-10 pr-4 py-2 bg-gray-100/50 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all outline-none placeholder-gray-400 text-gray-800";
                input.autocomplete = "off";
                
                input.addEventListener('input', (e) => handleSearch(e.target.value));

                searchContainer.appendChild(icon);
                searchContainer.appendChild(input);
                presetHeader.appendChild(searchContainer);
                lucide.createIcons();
                
            } else {
                const title = document.createElement('h2');
                title.className = "text-xs font-bold text-gray-400 uppercase tracking-widest px-1 py-1 flex items-center gap-2";
                title.innerHTML = `<span>${currentCategory.name}</span> <div class="h-px bg-gray-100 flex-1"></div>`;
                presetHeader.appendChild(title);
            }
        }

        // --- Views ---

        function renderSearchUI() {
             presetsGrid.innerHTML = `
                <div class="flex flex-col items-center justify-center h-48 text-gray-300 w-full">
                    <i data-lucide="search" class="w-10 h-10 mb-2 opacity-50"></i>
                    <span class="text-xs font-medium">검색어를 입력하세요</span>
                </div>
            `;
            lucide.createIcons();
            
            setTimeout(() => {
                const searchBox = document.getElementById('categorySearchInput');
                if(searchBox) searchBox.focus();
            }, 50);
        }

        function renderAiInterface() {
            // Change layout to flex-col for AI view
            presetsGrid.classList.remove('flex-wrap', 'gap-3', 'content-start');
            presetsGrid.classList.add('flex', 'flex-col', 'gap-4');

            presetsGrid.innerHTML = `
                <div class="flex flex-col gap-4 w-full">
                    
                    <div class="bg-white rounded-xl p-1 border border-indigo-100 shadow-sm relative overflow-hidden group focus-within:ring-2 focus-within:ring-indigo-500/20 transition-all">
                        <div class="absolute inset-0 bg-gradient-to-br from-indigo-50/50 to-purple-50/50 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                        <textarea id="aiPromptInput" 
                            class="w-full h-24 p-3 bg-transparent rounded-lg text-sm text-gray-700 placeholder-gray-400 resize-none outline-none focus:bg-white transition-colors z-10 relative leading-relaxed" 
                            placeholder="원하는 수식을 한글로 설명해주세요.&#10;예: 2차 방정식의 근의 공식&#10;예: 3행 3열 단위행렬"></textarea>
                        
                        <div class="px-3 pb-3 flex justify-between items-center bg-transparent relative z-10 border-t border-gray-100/50 pt-2 mt-1">
                            <span class="text-[10px] text-gray-400 font-medium flex items-center gap-1"><i data-lucide="zap" class="w-3 h-3 text-amber-400"></i>AI Powered</span>
                            <button onclick="generateWithAI()" id="aiBtn" class="bg-gray-900 hover:bg-black text-white text-xs font-semibold px-4 py-1.5 rounded-lg shadow hover:shadow-lg hover:scale-[1.02] active:scale-95 transition-all flex items-center gap-1.5">
                                <i data-lucide="sparkles" class="w-3 h-3 text-indigo-300"></i> 생성
                            </button>
                        </div>
                    </div>

                    <!-- Enhanced AI Result Card -->
                    <div id="aiResultCard" class="hidden w-full bg-white rounded-xl border border-indigo-200 shadow-sm overflow-hidden group hover:shadow-md transition-all cursor-pointer relative" onclick="insertAiResult()">
                        <!-- Preview Header -->
                        <div class="h-32 bg-gray-50/50 flex items-center justify-center p-4 border-b border-gray-100 group-hover:bg-indigo-50/30 transition-colors">
                            <div id="aiPreview" class="text-xl text-gray-800 transition-transform duration-300 group-hover:scale-110"></div>
                        </div>
                        
                        <!-- Code Footer -->
                        <div class="p-3 bg-white relative">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-[10px] font-bold text-gray-400 uppercase">Generated LaTeX</span>
                            </div>
                            <p class="text-xs text-indigo-600 font-mono truncate bg-indigo-50/50 px-2 py-1 rounded" id="aiCodeDisplay"></p>
                            
                            <!-- Hidden Code Storage -->
                            <div id="aiResultText" class="hidden"></div>

                            <!-- Actions (Visible on Hover) -->
                            <div class="absolute right-2 top-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white/90 backdrop-blur rounded-lg p-1 shadow-sm border border-gray-100">
                                 <button onclick="event.stopPropagation(); copyAiResult()" class="p-1.5 hover:bg-gray-100 rounded text-gray-500 hover:text-gray-900" title="복사">
                                    <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                                 </button>
                                 <button onclick="event.stopPropagation(); insertAiResult()" class="p-1.5 hover:bg-indigo-50 rounded text-indigo-500 hover:text-indigo-700" title="입력">
                                    <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                                 </button>
                            </div>
                        </div>
                        <div class="absolute inset-0 border-2 border-indigo-500 rounded-xl opacity-0 hover:opacity-100 pointer-events-none transition-opacity"></div>
                    </div>

                    <div id="aiTip" class="mt-2 p-3 rounded-xl bg-blue-50/50 border border-blue-100/60 flex gap-3 items-start">
                         <div class="bg-blue-100 p-1.5 rounded-full shrink-0 text-blue-600 mt-0.5">
                            <i data-lucide="lightbulb" class="w-3.5 h-3.5"></i>
                         </div>
                         <div>
                            <h4 class="text-xs font-bold text-blue-800 mb-0.5">Tip</h4>
                            <p class="text-[11px] text-blue-600/80 leading-relaxed">
                                결과 카드를 클릭하면 에디터 커서 위치에 바로 입력됩니다.
                            </p>
                         </div>
                    </div>

                </div>
            `;
            lucide.createIcons();
        }

        async function generateWithAI() {
            const promptInput = document.getElementById('aiPromptInput');
            const prompt = promptInput.value.trim();
            const btn = document.getElementById('aiBtn');
            const resultCard = document.getElementById('aiResultCard');
            const resultText = document.getElementById('aiResultText');
            const codeDisplay = document.getElementById('aiCodeDisplay');
            const previewDiv = document.getElementById('aiPreview');

            if (!prompt) return;

            // Loading State
            const originalBtnContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> 생성중...`;
            lucide.createIcons();

            try {
                const apiKey = "AIzaSyAIHSgzZyA9QQQxblSfCfyx83rE9siCI2E"; // Runtime Environment will provide this key
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ 
                            parts: [{ 
                                text: `You are a LaTeX expert. Convert the following natural language description into valid LaTeX math code. 
                                Rule 1: Output ONLY the LaTeX code. 
                                Rule 2: Do NOT include markdown formatting (like \`\`\`latex). 
                                Rule 3: Do NOT include explanations.
                                User Description: "${prompt}"` 
                            }] 
                        }]
                    })
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();
                let generatedText = data.candidates[0].content.parts[0].text.trim();
                
                // Cleanup Markdown if exists
                generatedText = generatedText.replace(/^```latex|```$/g, '').trim();
                generatedText = generatedText.replace(/^```|```$/g, '').trim();

                // Update UI
                resultText.textContent = generatedText;
                codeDisplay.textContent = generatedText;
                
                // Render Preview
                previewDiv.textContent = `$$${generatedText}$$`;
                if (window.MathJax && window.mathJaxReady) {
                    await MathJax.typesetPromise([previewDiv]);
                }

                resultCard.classList.remove('hidden');
                resultCard.classList.add('animate-fade-in');

                // Hide Tip to save space
                const tip = document.getElementById('aiTip');
                if(tip) tip.style.display = 'none';

            } catch (error) {
                console.error(error);
                alert('AI 생성 중 오류가 발생했습니다. 다시 시도해주세요.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnContent;
                lucide.createIcons();
            }
        }

        function insertAiResult() {
            const code = document.getElementById('aiResultText').textContent;
            insertLatex(code);
            
            // Visual Feedback
            const card = document.getElementById('aiResultCard');
            card.classList.add('ring-2', 'ring-indigo-500', 'ring-offset-2');
            setTimeout(() => card.classList.remove('ring-2', 'ring-indigo-500', 'ring-offset-2'), 200);
        }

        function copyAiResult() {
            const code = document.getElementById('aiResultText').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const btn = document.querySelector('button[onclick="event.stopPropagation(); copyAiResult()"]');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = `<i data-lucide="check" class="w-3.5 h-3.5 text-green-500"></i>`;
                lucide.createIcons();
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    lucide.createIcons();
                }, 1500);
            });
        }

        function handleSearch(term) {
             // Reset grid classes for search results (grid layout)
            presetsGrid.className = 'content-transition-wrapper min-h-full flex-1 overflow-y-auto p-3 flex flex-wrap gap-3 content-start pb-10';
            
            if (!term.trim()) {
                renderSearchUI();
                return;
            }
            
            const lowerTerm = term.toLowerCase();
            const results = allItems.filter(item => 
                item.name.toLowerCase().includes(lowerTerm) || 
                item.keywords.toLowerCase().includes(lowerTerm) ||
                item.latex.toLowerCase().includes(lowerTerm)
            );
            
            renderPresets(results, true);
        }

        function renderPresets(items, isSearchResult = false) {
            presetsGrid.innerHTML = '';
            
            if (items.length === 0 && isSearchResult) {
                presetsGrid.innerHTML = `
                    <div class="w-full text-center text-gray-400 text-xs py-8 animate-fade-in">
                        검색 결과가 없습니다.
                    </div>`;
                return;
            }

            items.forEach((item, index) => {
                const card = document.createElement('div');
                const isLongFormula = item.latex.length > 30 || item.latex.includes('\\begin');
                const widthClass = isLongFormula ? 'w-full' : 'w-[calc(50%-0.375rem)]';
                
                // Staggered Animation Delay for initial load
                card.style.animationDelay = `${index * 30}ms`;
                // Use a different animation class if already in view to avoid re-triggering entrance
                card.className = `preset-item rounded-xl cursor-pointer relative overflow-hidden group subtle-shadow-out ${widthClass}`;
                
                card.onclick = () => insertLatex(item.latex);

                const previewContainer = document.createElement('div');
                previewContainer.className = 'preset-preview-container';
                
                const preview = document.createElement('div');
                preview.className = 'text-gray-800 z-10 text-center transition-transform duration-300 group-hover:scale-110';
                preview.textContent = `$$${item.latex}$$`;
                
                preview.style.fontSize = isLongFormula ? '0.85rem' : '1.1rem';

                previewContainer.appendChild(preview);
                
                const label = document.createElement('div');
                label.className = 'preset-label';
                label.textContent = item.name;
                
                card.appendChild(previewContainer);
                card.appendChild(label);
                presetsGrid.appendChild(card);
            });

            if (window.MathJax && window.mathJaxReady) {
                MathJax.typesetPromise([presetsGrid]).catch(err => console.log('Typeset error: ' + err.message));
            }
        }

        // --- Editor Logic ---
        function insertLatex(latexCode) {
            const start = latexInput.selectionStart;
            const end = latexInput.selectionEnd;
            const text = latexInput.value;
            
            const before = text.substring(0, start);
            const after = text.substring(end, text.length);
            
            latexInput.value = before + latexCode + after;
            latexInput.focus();
            const newPos = start + latexCode.length;
            latexInput.setSelectionRange(newPos, newPos);
            
            updatePreview();
        }

        function updatePreview() {
            const latex = latexInput.value.trim();
            let wrappedLatex = latex;
            
            if (latex.includes('\\\\') || latex.includes('\n')) {
                if (!latex.includes('\\begin{')) {
                    wrappedLatex = `\\begin{aligned} ${latex} \\end{aligned}`;
                }
            }
            
            previewOutput.textContent = `$$${wrappedLatex}$$`;
            
            if (window.MathJax && window.mathJaxReady) {
                MathJax.typesetPromise([previewOutput]).catch(err => console.log(err.message));
            }
        }

        function copyToClipboard() {
            latexInput.select();
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            
            const btn = document.querySelector('button[onclick="copyToClipboard()"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" class="w-4 h-4 text-green-500"></i> <span class="text-green-600">완료!</span>`;
            lucide.createIcons();
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                lucide.createIcons();
            }, 2000);
        }

        function clearEditor() {
            if(confirm('모든 내용을 지우시겠습니까?')) {
                latexInput.value = '';
                updatePreview();
            }
        }

        // --- Export Logic ---
        async function exportFormula(format) {
            closeExportDropdown();
            
            const color = exportColorPicker.value;
            const outputElement = previewOutput.querySelector('mjx-container');

            if (!outputElement) {
                alert('렌더링된 수식이 없습니다.');
                return;
            }

            const svgElement = outputElement.querySelector('svg');
            if (!svgElement) {
                alert('SVG 요소를 찾을 수 없습니다.');
                return;
            }

            const clonedSvg = svgElement.cloneNode(true);
            clonedSvg.setAttribute('fill', color);
            clonedSvg.style.color = color;

            clonedSvg.querySelectorAll('[fill]').forEach(el => el.removeAttribute('fill'));
            clonedSvg.querySelectorAll('[stroke]').forEach(el => el.removeAttribute('stroke'));
            
            const svgData = new XMLSerializer().serializeToString(clonedSvg);
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const svgUrl = URL.createObjectURL(svgBlob);

            if (format === 'svg') {
                const a = document.createElement('a');
                a.href = svgUrl;
                a.download = 'formula.svg';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(svgUrl);
            } else if (format === 'png') {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                img.onload = () => {
                    const svgWidth = clonedSvg.width.baseVal.value;
                    const svgHeight = clonedSvg.height.baseVal.value;
                    const scale = 4; // High Resolution
                    
                    canvas.width = svgWidth * scale;
                    canvas.height = svgHeight * scale;
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    const svgDataUrl = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        ctx.drawImage(tempImg, 0, 0, canvas.width, canvas.height);
                        const pngUrl = canvas.toDataURL('image/png');
                        
                        const a = document.createElement('a');
                        a.href = pngUrl;
                        a.download = 'formula.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(svgUrl);
                    };
                    tempImg.src = svgDataUrl;
                };
                
                const svgDataUrl = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
                img.src = svgDataUrl;
            }
        }

        latexInput.addEventListener('input', updatePreview);
        window.addEventListener('load', init);
    </script>
</body>
</html>
